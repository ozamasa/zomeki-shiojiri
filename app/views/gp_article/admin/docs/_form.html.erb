<%- inline_id = @item.id || Util::Sequencer.next_id(:tmp, md5: true) -%>

<span class="note">※は必須項目です。</span>

<table class="show">
  <tr>
    <th><%= f.label :title %> <span class="note">※</span></th>
    <td><%= f.text_field :title, :class => 'title', :style => 'width: 500px;' %></td>
    <th><%= f.label :title %>設定</th>
    <td><%= link_to_function '開く▼', "toggle_form(this, '#title_settings')" %></td>
  </tr>
</table>

<div id="title_settings" style="display: none;">
  <table class="show">
    <tr>
      <th><%= f.label :href %></th>
      <td><%= f.text_field :href, :style => 'width: 500px;' %></td>
      <td><%= f.radio_buttons :target, GpArticle::Doc::TARGET_OPTIONS %></td>
    </tr>
    <tr>
      <th><%= f.label :subtitle %></th>
      <td colspan="2"><%= f.text_field :subtitle, :style => 'width: 750px;' %></td>
    </tr>
    <tr>
      <th><%= f.label :summary %></th>
      <td colspan="2"><%= f.text_field :summary, :style => 'width: 750px;' %></td>
    </tr>
  </table>
</div>

<table class="show">
  <tr>
    <th><%= f.label :body %></th>
  </tr>
  <tr>
    <td class="cke_editor_wrapper">
      <%= init_ckeditor :baseHref => "#{gp_article_doc_path(@content, inline_id)}/" %>
      <%= f.text_area :body, :class => 'body ckeditor' %>
    </td>
  </tr>
</table>

<table class="show">
  <tr>
    <th>添付ファイル</th>
    <td>
      <%= link_to_function '開く▼', "toggle_form(this, '#inline_files')" %>
    </td>
  </tr>
</table>

<div id="inline_files" style="display: none;">
  <%= hidden_field_tag :_tmp, inline_id %>
  <iframe src="<%= gp_article_doc_files_path(@content, inline_id) %>" style="width: 100%; height: 340px;"></iframe>
</div>

<%- unless @category_types.empty? -%>
<table class="show">
  <%- @category_types.each do |category_type| -%>
  <tr>
    <th><%= category_type.title %></th>
    <td>
      <table id="category_type_<%= category_type.id %>_categories" class="noDesign">
        <tbody>
          <%= render 'category', category_type: category_type, category: category_type.categories.build, available: false -%>
          <%- @item.categories.where(category_type_id: category_type.id).each do |category| -%>
            <%= render 'category', category_type: category_type, category: category, available: true %>
          <%- end -%>
          <tr>
            <td>&nbsp;</td>
            <td style="text-align: right;"><div style="margin-top: -55px;"><%= button_tag '追加', type: 'button', id: "add_category_type_#{category_type.id}_categories_line" %></div></td>
          </tr>
        </tbody>
      </table>
    </td>
  </tr>
  <%- end -%>
</table>
<%- end -%>

<%= google_map_form f %>
<%= inquiry_form f %>
<%= task_form f %>
<%= recognizer_form f %>
<%= creator_form f %>

<%= javascript_tag do -%>
function toggle_form(link, target, open_label, close_label) {
  if (open_label === undefined) open_label = '開く▼';
  if (close_label === undefined) close_label = '閉じる▲';
  var l = jQuery(link);
  var t = jQuery(target);
  if (t.is(':hidden')) {
    l.html(close_label);
  } else {
    l.html(open_label);
  }
  t.slideToggle();
}

function set_click_event_handler(category_type_id) {
  $('#add_category_type_' + category_type_id + '_categories_line').on('click', function () {
    var categories_tbody = $('#category_type_' + category_type_id + '_categories > tbody');
    categories_tbody.find('tr:first-child').clone(true).insertBefore(categories_tbody.find('tr:last-child')).show();
    categories_tbody.find('tr:visible').each(function (idx, tr) {
      $(tr).find(':disabled').removeAttr('disabled');
    });
  }).trigger('click');
}

$(document).ready(function () {
  $('form').keypress(function (event) { if (event.target.type !== 'textarea' && event.which === 13) return false; });

  <%- @category_types.each do |category_type| -%>
  set_click_event_handler('<%= category_type.id %>');
  <%- end -%>
});
<%- end -%>
